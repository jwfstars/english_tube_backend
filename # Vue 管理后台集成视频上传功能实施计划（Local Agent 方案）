# Vue ç®¡ç†åå°é›†æˆè§†é¢‘ä¸Šä¼ åŠŸèƒ½å®æ–½è®¡åˆ’ï¼ˆLocal Agent æ–¹æ¡ˆï¼‰

## âš ï¸ æ–¹æ¡ˆæ›´æ–°è¯´æ˜

**åŸæ–¹æ¡ˆé—®é¢˜**ï¼š
- âŒ Backend åœ¨å›½å†…æœåŠ¡å™¨ï¼Œæ— æ³•è®¿é—® YouTubeï¼ˆGFWï¼‰
- âŒ è§†é¢‘å¤„ç†ä¼šå ç”¨æœåŠ¡å™¨å¤§é‡èµ„æºï¼ˆå†…å­˜ 4-8GBï¼ŒCPU å¯†é›†ï¼‰

**æ–°æ–¹æ¡ˆ**ï¼šLocal Uploader Agent
- âœ… å¤„ç†åœ¨ç”¨æˆ·æœ¬åœ°è¿›è¡Œï¼ˆå¯ä»¥è®¿é—® YouTubeï¼‰
- âœ… ä¸å ç”¨æœåŠ¡å™¨èµ„æº
- âœ… çº¿ä¸Šå’Œæœ¬åœ° Vue Admin éƒ½èƒ½ç”¨

---

## ä¸€ã€æ–¹æ¡ˆæ¦‚è¿°

**ç›®æ ‡**ï¼šåœ¨ Vue.js ç®¡ç†åå°æ·»åŠ å®Œæ•´çš„è§†é¢‘ä¸Šä¼ åŠŸèƒ½ï¼Œå®Œå…¨è¿ç§» CLI segment æµç¨‹ã€‚

**æ ¸å¿ƒæ¶æ„**ï¼šLocal Agent æ–¹æ¡ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Vue Admin (english_tube_admin)                   â”‚
â”‚ - è§†é¢‘ç®¡ç†                                        â”‚
â”‚ - ã€æ–°å¢ã€‘ä¸Šä¼ é¡µé¢                                â”‚
â”‚   â””â”€ æ£€æµ‹æœ¬åœ° Agent                              â”‚
â”‚   â””â”€ å‘èµ·ä¸Šä¼ è¯·æ±‚ â†’ http://localhost:9000       â”‚
â”‚   â””â”€ å®æ—¶è¿›åº¦æ˜¾ç¤ºï¼ˆWebSocketï¼‰                   â”‚
â”‚                                                   â”‚
â”‚ è¿è¡Œä½ç½®ï¼šæµè§ˆå™¨ï¼ˆæœ¬åœ°æˆ–çº¿ä¸Šè®¿é—®éƒ½å¯ä»¥ï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ HTTP API (æŸ¥è¯¢æ•°æ®)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend API (backend)                            â”‚
â”‚ - è§†é¢‘ CRUD                                       â”‚
â”‚ - upload_tasks è¡¨ï¼ˆå­˜å‚¨ä¸Šä¼ å†å²ï¼‰                 â”‚
â”‚ - âŒ ä¸åšè§†é¢‘å¤„ç†                                 â”‚
â”‚                                                   â”‚
â”‚ è¿è¡Œä½ç½®ï¼šå›½å†…äº‘æœåŠ¡å™¨                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘ å†™å…¥æ•°æ®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Local Uploader Agent (uploader/agent.py)        â”‚
â”‚ - HTTP æœåŠ¡ï¼šhttp://localhost:9000               â”‚
â”‚ - æ¥æ”¶ä¸Šä¼ è¯·æ±‚                                    â”‚
â”‚ - æ‰§è¡Œ VideoProcessingPipeline                   â”‚
â”‚   â””â”€ ä¸‹è½½ YouTube è§†é¢‘                           â”‚
â”‚   â””â”€ FFmpeg å¤„ç†                                 â”‚
â”‚   â””â”€ WhisperX è¯­éŸ³è¯†åˆ«                           â”‚
â”‚   â””â”€ AI ç”Ÿæˆå­¦ä¹ å†…å®¹                             â”‚
â”‚   â””â”€ ä¸Šä¼ åˆ°è…¾è®¯äº‘ VOD/COS                        â”‚
â”‚   â””â”€ å†™å…¥ Backend API                            â”‚
â”‚ - WebSocket æ¨é€è¿›åº¦                             â”‚
â”‚                                                   â”‚
â”‚ è¿è¡Œä½ç½®ï¼šç”¨æˆ·æœ¬åœ° Mac                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… å®Œå…¨å¤ç”¨ `VideoProcessingPipeline`
- âœ… è§£å†³ YouTube è®¿é—®é—®é¢˜ï¼ˆæœ¬åœ°å¯ç”¨ä»£ç†ï¼‰
- âœ… è§£å†³èµ„æºæ¶ˆè€—é—®é¢˜ï¼ˆä¸å ç”¨æœåŠ¡å™¨ï¼‰
- âœ… çº¿ä¸Šå’Œæœ¬åœ° Vue Admin éƒ½èƒ½ä½¿ç”¨
- âœ… JavaScript åœ¨æµè§ˆå™¨è¿è¡Œï¼Œè‡ªåŠ¨è®¿é—® localhost:9000

**ç”¨æˆ·é—®é¢˜è§£ç­”**ï¼š
- **çº¿ä¸Š admin èƒ½ä¸Šä¼ å—ï¼Ÿ** â†’ **YES**ï¼ŒJavaScript åœ¨æµè§ˆå™¨è¿è¡Œï¼Œè®¿é—®ç”¨æˆ·æœ¬åœ°çš„ Agent
- **å¿…é¡»å¯åŠ¨æœ¬åœ° Agentï¼Ÿ** â†’ **YES**ï¼Œéœ€è¦å…ˆè¿è¡Œ `python -m uploader.agent`

---

## äºŒã€å®æ–½æ­¥éª¤

### Phase 1ï¼šLocal Uploader Agentï¼ˆæ ¸å¿ƒï¼‰

#### Step 1.1ï¼šåˆ›å»º Local Agent æœåŠ¡

**æ–°å»ºæ–‡ä»¶**ï¼š`/uploader/uploader/agent.py`

**åŠŸèƒ½**ï¼š
- æä¾› HTTP APIï¼ˆç«¯å£ 9000ï¼‰
- æ¥æ”¶ Vue Admin çš„ä¸Šä¼ è¯·æ±‚
- æ‰§è¡Œ VideoProcessingPipeline
- é€šè¿‡ WebSocket æ¨é€å®æ—¶è¿›åº¦
- é…ç½® CORS å…è®¸çº¿ä¸Š Vue Admin è®¿é—®

**æ ¸å¿ƒä»£ç **ï¼š
```python
from fastapi import FastAPI, WebSocket, BackgroundTasks
from fastapi.middleware.cors import CORSMiddleware
from uploader.pipeline import VideoProcessingPipeline, ProcessingCallbacks
from uuid import uuid4
from typing import Dict, Set
import asyncio

app = FastAPI(title="Local Uploader Agent")

# é…ç½® CORSï¼ˆå…è®¸çº¿ä¸Š Vue Admin è®¿é—®ï¼‰
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:8858",          # æœ¬åœ°å¼€å‘
        "https://yourdomain.com",         # çº¿ä¸Šéƒ¨ç½²
        "https://englishtube.top",        # å®é™…åŸŸå
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

class AgentTaskManager:
    def __init__(self):
        self.tasks: Dict[str, asyncio.Task] = {}
        self.websockets: Dict[str, Set[WebSocket]] = {}
        self.task_status: Dict[str, dict] = {}

    async def start_task(self, task_id: str, params: dict):
        """å¯åŠ¨å¼‚æ­¥å¤„ç†ä»»åŠ¡"""
        task = asyncio.create_task(self._run_pipeline(task_id, params))
        self.tasks[task_id] = task

    async def _run_pipeline(self, task_id: str, params: dict):
        """è¿è¡Œ VideoProcessingPipeline"""
        try:
            # æ›´æ–°çŠ¶æ€
            self.task_status[task_id] = {
                "status": "running",
                "progress": 0,
                "message": "å¼€å§‹å¤„ç†..."
            }

            # åˆ›å»ºå›è°ƒ
            callbacks = self._create_callbacks(task_id)

            # æ‰§è¡Œå¤„ç†
            pipeline = VideoProcessingPipeline(callbacks=callbacks)
            result = pipeline.process(**params)

            # æ›´æ–°çŠ¶æ€
            self.task_status[task_id] = {
                "status": "completed",
                "progress": 100,
                "result": {
                    "video_id": str(result.video_id) if result.video_id else None,
                    "segments_count": result.segments_count,
                    "words_count": result.words_count,
                    "phrases_count": result.phrases_count,
                }
            }

            # æ¨é€å®Œæˆæ¶ˆæ¯
            await self._broadcast(task_id, {
                "type": "complete",
                "result": self.task_status[task_id]["result"]
            })

        except Exception as e:
            self.task_status[task_id] = {
                "status": "failed",
                "error": str(e)
            }
            await self._broadcast(task_id, {
                "type": "error",
                "message": str(e)
            })

    def _create_callbacks(self, task_id: str):
        """åˆ›å»º WebSocket æ¨é€å›è°ƒ"""
        return ProcessingCallbacks(
            on_status=lambda msg: asyncio.create_task(
                self._broadcast(task_id, {"type": "status", "message": msg})
            ),
            on_progress=lambda cur, tot, msg: asyncio.create_task(
                self._broadcast(task_id, {
                    "type": "progress",
                    "current": cur,
                    "total": tot,
                    "message": msg
                })
            ),
            on_step_start=lambda step: asyncio.create_task(
                self._broadcast(task_id, {"type": "step_start", "step": step})
            ),
            on_step_complete=lambda step: asyncio.create_task(
                self._broadcast(task_id, {"type": "step_complete", "step": step})
            ),
            on_error=lambda err: asyncio.create_task(
                self._broadcast(task_id, {"type": "error", "message": err})
            ),
        )

    async def _broadcast(self, task_id: str, message: dict):
        """å¹¿æ’­æ¶ˆæ¯åˆ°æ‰€æœ‰è¿æ¥çš„ WebSocket"""
        if task_id in self.websockets:
            dead_sockets = set()
            for ws in self.websockets[task_id]:
                try:
                    await ws.send_json(message)
                except:
                    dead_sockets.add(ws)

            # æ¸…ç†æ–­å¼€çš„è¿æ¥
            self.websockets[task_id] -= dead_sockets

    def register_websocket(self, task_id: str, ws: WebSocket):
        """æ³¨å†Œ WebSocket è¿æ¥"""
        if task_id not in self.websockets:
            self.websockets[task_id] = set()
        self.websockets[task_id].add(ws)

    def unregister_websocket(self, task_id: str, ws: WebSocket):
        """æ³¨é”€ WebSocket è¿æ¥"""
        if task_id in self.websockets:
            self.websockets[task_id].discard(ws)

# å…¨å±€ä»»åŠ¡ç®¡ç†å™¨
task_manager = AgentTaskManager()

@app.get("/health")
async def health_check():
    """å¥åº·æ£€æŸ¥ï¼ˆç”¨äº Vue Admin æ£€æµ‹ Agent æ˜¯å¦è¿è¡Œï¼‰"""
    return {"status": "ok", "agent": "Local Uploader Agent", "version": "1.0.0"}

@app.post("/upload")
async def upload_video(params: dict, background_tasks: BackgroundTasks):
    """æ¥æ”¶ä¸Šä¼ è¯·æ±‚"""
    task_id = str(uuid4())

    # å¯åŠ¨åå°ä»»åŠ¡
    background_tasks.add_task(task_manager.start_task, task_id, params)

    return {"task_id": task_id, "status": "pending"}

@app.websocket("/ws/{task_id}")
async def websocket_endpoint(websocket: WebSocket, task_id: str):
    """WebSocket è¿›åº¦æ¨é€"""
    await websocket.accept()
    task_manager.register_websocket(task_id, websocket)

    try:
        while True:
            # Keep alive
            await websocket.receive_text()
    except:
        pass
    finally:
        task_manager.unregister_websocket(task_id, websocket)

@app.get("/status/{task_id}")
async def get_task_status(task_id: str):
    """æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€"""
    if task_id in task_manager.task_status:
        return task_manager.task_status[task_id]
    else:
        return {"status": "not_found"}

if __name__ == "__main__":
    import uvicorn
    print("ğŸš€ Local Uploader Agent å¯åŠ¨ä¸­...")
    print("ğŸ“¡ ç›‘å¬ç«¯å£: http://localhost:9000")
    print("âœ… å…è®¸è·¨åŸŸ: https://yourdomain.com")
    print("ğŸ’¡ åœ¨ Vue Admin ä¸­å¯ä»¥å¼€å§‹ä¸Šä¼ äº†ï¼")
    uvicorn.run(app, host="0.0.0.0", port=9000)
```

#### Step 1.2ï¼šæ·»åŠ å¯åŠ¨è„šæœ¬

**æ–°å»ºæ–‡ä»¶**ï¼š`/uploader/uploader/__main__.py`

```python
"""
å¯åŠ¨ Local Uploader Agent

ä½¿ç”¨æ–¹æ³•ï¼š
    python -m uploader.agent
"""

if __name__ == "__main__":
    from uploader.agent import app
    import uvicorn

    uvicorn.run(app, host="0.0.0.0", port=9000, log_level="info")
```

**ä½¿ç”¨æ–¹å¼**ï¼š
```bash
cd /Users/winfield/workspace/Apps/projects/english_tube/uploader
python -m uploader.agent
```

#### Step 1.3ï¼šSchema å®šä¹‰

**æ–°å»ºæ–‡ä»¶**ï¼š`/uploader/uploader/schemas.py`

```python
from pydantic import BaseModel, HttpUrl
from typing import Optional

class UploadParams(BaseModel):
    """ä¸Šä¼ å‚æ•°"""
    youtube_url: HttpUrl
    quality: int = 720
    whisper_model: str = "small"
    min_duration: int = 60
    max_duration: int = 120
    target_segments: Optional[int] = None
    skip_learning: bool = False
    upload_db: bool = True
    upload_cos: bool = True

class TaskStatus(BaseModel):
    """ä»»åŠ¡çŠ¶æ€"""
    task_id: str
    status: str  # pending/running/completed/failed
    progress: int = 0
    message: Optional[str] = None
    result: Optional[dict] = None
    error: Optional[str] = None
```

---

### Phase 2ï¼šBackend APIï¼ˆè½»é‡çº§ï¼‰

#### Step 2.1ï¼šæ•°æ®åº“ Schema

**æ–°å¢è¡¨**ï¼š`upload_tasks` - ä»…ç”¨äºè®°å½•å†å²ï¼Œä¸æ‰§è¡Œå¤„ç†

**åˆ›å»º migration**ï¼š
```bash
cd /Users/winfield/workspace/Apps/projects/english_tube/backend
source ../.venv/bin/activate
alembic revision -m "add upload_tasks table"
```

**æ–‡ä»¶ä½ç½®**ï¼š
- Model: `/backend/app/models/upload_task.py` (æ–°å»º)
- Migration: `/backend/alembic/versions/xxx_add_upload_tasks.py` (è‡ªåŠ¨ç”Ÿæˆ)

**è¡¨ç»“æ„**ï¼š
```sql
CREATE TABLE upload_tasks (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    youtube_url TEXT NOT NULL,

    -- é…ç½®å‚æ•°
    quality INTEGER DEFAULT 720,
    whisper_model VARCHAR(20) DEFAULT 'small',

    -- ä»»åŠ¡çŠ¶æ€ï¼ˆç”± Local Agent å†™å…¥ï¼‰
    status VARCHAR(20) DEFAULT 'pending',

    -- ç»“æœ
    video_id UUID REFERENCES videos(id),
    segments_count INTEGER DEFAULT 0,
    words_count INTEGER DEFAULT 0,
    phrases_count INTEGER DEFAULT 0,
    error_message TEXT,

    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP
);
```

#### Step 2.2ï¼šAPI Endpointsï¼ˆå¯é€‰ï¼‰

**æ–°å»ºæ–‡ä»¶**ï¼š`/backend/app/api/v1/endpoints/upload_history.py`

**åŠŸèƒ½**ï¼šä»…æä¾›æŸ¥è¯¢æ¥å£ï¼Œä¸å¤„ç†ä¸Šä¼ 

```python
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session
from app.models.upload_task import UploadTask
from app.api.deps import get_db

router = APIRouter()

@router.get("/history")
async def get_upload_history(
    skip: int = 0,
    limit: int = 20,
    db: Session = Depends(get_db)
):
    """è·å–ä¸Šä¼ å†å²"""
    tasks = db.query(UploadTask).order_by(
        UploadTask.created_at.desc()
    ).offset(skip).limit(limit).all()

    total = db.query(UploadTask).count()

    return {"items": tasks, "total": total}

@router.get("/history/{task_id}")
async def get_upload_task(task_id: str, db: Session = Depends(get_db)):
    """è·å–ä»»åŠ¡è¯¦æƒ…"""
    task = db.query(UploadTask).filter(UploadTask.id == task_id).first()
    return task
```

**æ³¨å†Œè·¯ç”±**ï¼ˆå¯é€‰ï¼‰ï¼š
```python
# backend/app/api/v1/api.py
from app.api.v1.endpoints import upload_history

api_router.include_router(
    upload_history.router,
    prefix="/upload",
    tags=["upload"]
)
```

---

### Phase 3ï¼šVue Admin ä¸Šä¼ é¡µé¢

#### Step 3.1ï¼šåˆ›å»ºä¸Šä¼ é¡µé¢

**æ–°å»ºæ–‡ä»¶**ï¼š`/english_tube_admin/src/views/admin/upload/index.vue`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. æ£€æµ‹æœ¬åœ° Agent æ˜¯å¦è¿è¡Œ
2. é…ç½®è¡¨å•
3. å®æ—¶è¿›åº¦æ˜¾ç¤º
4. ç»“æœå±•ç¤º

**å®Œæ•´ä»£ç **ï¼š
```vue
<template>
  <div class="upload-container">
    <!-- Agent çŠ¶æ€æ£€æµ‹ -->
    <el-alert
      v-if="!agentRunning"
      type="warning"
      title="æœ¬åœ° Uploader Agent æœªè¿è¡Œ"
      :closable="false"
      show-icon
    >
      <template #default>
        <p>è¯·åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨ Agentï¼š</p>
        <el-code style="margin-top: 10px; display: block">
          cd /path/to/uploader<br>
          python -m uploader.agent
        </el-code>
        <el-button
          @click="detectAgent"
          type="primary"
          size="small"
          style="margin-top: 10px"
        >
          é‡æ–°æ£€æµ‹
        </el-button>
      </template>
    </el-alert>

    <!-- ä¸Šä¼ è¡¨å• -->
    <el-card v-if="agentRunning" style="margin-top: 20px">
      <template #header>
        <div class="card-header">
          <span>è§†é¢‘ä¸Šä¼ é…ç½®</span>
          <el-tag type="success" size="small">
            æœ¬åœ° Agent å·²è¿æ¥
          </el-tag>
        </div>
      </template>

      <el-form :model="form" label-width="140px" :rules="rules" ref="formRef">
        <el-form-item label="YouTube URL" prop="youtube_url" required>
          <el-input
            v-model="form.youtube_url"
            placeholder="https://www.youtube.com/watch?v=xxx"
          />
        </el-form-item>

        <el-form-item label="è§†é¢‘è´¨é‡">
          <el-select v-model="form.quality">
            <el-option label="360p" :value="360" />
            <el-option label="480p" :value="480" />
            <el-option label="720p (æ¨è)" :value="720" />
            <el-option label="1080p" :value="1080" />
          </el-select>
        </el-form-item>

        <el-form-item label="Whisper æ¨¡å‹">
          <el-select v-model="form.whisper_model">
            <el-option label="Tiny (æœ€å¿«)" value="tiny" />
            <el-option label="Base (å¿«é€Ÿ)" value="base" />
            <el-option label="Small (æ¨è)" value="small" />
            <el-option label="Medium (æ›´å‡†ç¡®)" value="medium" />
          </el-select>
        </el-form-item>

        <el-form-item label="åˆ†æ®µæ—¶é•¿">
          <el-row :gutter="20">
            <el-col :span="12">
              <el-input-number
                v-model="form.min_duration"
                :min="30"
                :max="300"
                style="width: 100%"
              />
              <span style="margin-left: 10px">ç§’ï¼ˆæœ€å°ï¼‰</span>
            </el-col>
            <el-col :span="12">
              <el-input-number
                v-model="form.max_duration"
                :min="60"
                :max="600"
                style="width: 100%"
              />
              <span style="margin-left: 10px">ç§’ï¼ˆæœ€å¤§ï¼‰</span>
            </el-col>
          </el-row>
        </el-form-item>

        <el-form-item label="ç›®æ ‡åˆ†æ®µæ•°">
          <el-input-number
            v-model="form.target_segments"
            :min="1"
            clearable
            style="width: 200px"
          />
          <span style="margin-left: 10px; color: #999">
            ï¼ˆç•™ç©ºè‡ªåŠ¨åˆ¤æ–­ï¼‰
          </span>
        </el-form-item>

        <el-form-item label="é«˜çº§é€‰é¡¹">
          <el-checkbox v-model="form.skip_learning">
            è·³è¿‡å­¦ä¹ å†…å®¹ç”Ÿæˆ
          </el-checkbox>
        </el-form-item>

        <el-form-item>
          <el-button
            type="primary"
            @click="startUpload"
            :loading="uploading"
            :disabled="!agentRunning"
          >
            {{ uploading ? 'å¤„ç†ä¸­...' : 'å¼€å§‹ä¸Šä¼ ' }}
          </el-button>
        </el-form-item>
      </el-form>
    </el-card>

    <!-- è¿›åº¦å±•ç¤º -->
    <el-card v-if="taskId" style="margin-top: 20px">
      <template #header>
        <div class="card-header">
          <span>å¤„ç†è¿›åº¦</span>
          <el-tag :type="progressStatus">{{ statusText }}</el-tag>
        </div>
      </template>

      <el-progress
        :percentage="progress"
        :status="progressStatus === 'success' ? 'success' : undefined"
      />

      <div v-if="currentStep" class="current-step">
        <el-icon><Loading /></el-icon>
        {{ currentStep }}
      </div>

      <!-- å®æ—¶æ—¥å¿— -->
      <el-timeline style="margin-top: 20px; max-height: 400px; overflow-y: auto">
        <el-timeline-item
          v-for="log in logs"
          :key="log.id"
          :timestamp="log.time"
          :type="log.type"
        >
          {{ log.message }}
        </el-timeline-item>
      </el-timeline>

      <!-- å®Œæˆç»“æœ -->
      <el-result
        v-if="uploadResult"
        icon="success"
        title="ä¸Šä¼ æˆåŠŸï¼"
        style="margin-top: 20px"
      >
        <template #sub-title>
          <p>è§†é¢‘ ID: {{ uploadResult.video_id }}</p>
          <p>ç”Ÿæˆç‰‡æ®µ: {{ uploadResult.segments_count }} ä¸ª</p>
          <p>å•è¯å¡ç‰‡: {{ uploadResult.words_count }} ä¸ª</p>
          <p>çŸ­è¯­å¡ç‰‡: {{ uploadResult.phrases_count }} ä¸ª</p>
        </template>
        <template #extra>
          <el-button type="primary" @click="resetForm">å†ä¼ ä¸€ä¸ª</el-button>
        </template>
      </el-result>
    </el-card>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, reactive } from 'vue'
import { ElMessage } from 'element-plus'

const AGENT_URL = 'http://localhost:9000'

// Agent çŠ¶æ€
const agentRunning = ref(false)

// è¡¨å•
const form = reactive({
  youtube_url: '',
  quality: 720,
  whisper_model: 'small',
  min_duration: 60,
  max_duration: 120,
  target_segments: null,
  skip_learning: false
})

const rules = {
  youtube_url: [
    { required: true, message: 'è¯·è¾“å…¥ YouTube URL', trigger: 'blur' }
  ]
}

// ä»»åŠ¡çŠ¶æ€
const taskId = ref('')
const uploading = ref(false)
const progress = ref(0)
const currentStep = ref('')
const logs = ref<any[]>([])
const uploadResult = ref<any>(null)
const progressStatus = ref('')
const statusText = ref('å‡†å¤‡ä¸­')

// æ£€æµ‹æœ¬åœ° Agent
async function detectAgent() {
  try {
    const response = await fetch(`${AGENT_URL}/health`)
    if (response.ok) {
      agentRunning.value = true
      ElMessage.success('æ£€æµ‹åˆ°æœ¬åœ° Agent')
    }
  } catch (error) {
    agentRunning.value = false
    ElMessage.warning('æœ¬åœ° Agent æœªè¿è¡Œï¼Œè¯·å…ˆå¯åŠ¨')
  }
}

// å¼€å§‹ä¸Šä¼ 
async function startUpload() {
  uploading.value = true
  progress.value = 0
  logs.value = []
  uploadResult.value = null
  currentStep.value = ''
  statusText.value = 'å¤„ç†ä¸­'

  try {
    // 1. åˆ›å»ºä»»åŠ¡
    const response = await fetch(`${AGENT_URL}/upload`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(form)
    })

    const { task_id } = await response.json()
    taskId.value = task_id

    addLog('info', 'ä»»åŠ¡å·²åˆ›å»ºï¼Œå¼€å§‹å¤„ç†...')

    // 2. WebSocket è¿æ¥
    connectWebSocket(task_id)
  } catch (error) {
    ElMessage.error('ä¸Šä¼ å¤±è´¥: ' + error.message)
    uploading.value = false
  }
}

// WebSocket è¿æ¥
function connectWebSocket(taskId: string) {
  const ws = new WebSocket(`ws://localhost:9000/ws/${taskId}`)

  ws.onopen = () => {
    addLog('success', 'WebSocket è¿æ¥æˆåŠŸ')
  }

  ws.onmessage = (event) => {
    const msg = JSON.parse(event.data)

    switch (msg.type) {
      case 'status':
        addLog('info', msg.message)
        break

      case 'progress':
        progress.value = Math.floor((msg.current / msg.total) * 100)
        currentStep.value = msg.message
        addLog('info', `è¿›åº¦: ${msg.current}/${msg.total} - ${msg.message}`)
        break

      case 'step_start':
        addLog('primary', `å¼€å§‹: ${msg.step}`)
        break

      case 'step_complete':
        addLog('success', `å®Œæˆ: ${msg.step}`)
        break

      case 'complete':
        progress.value = 100
        progressStatus.value = 'success'
        statusText.value = 'å®Œæˆ'
        uploading.value = false
        uploadResult.value = msg.result
        addLog('success', 'å¤„ç†å®Œæˆï¼')
        break

      case 'error':
        progressStatus.value = 'exception'
        statusText.value = 'å¤±è´¥'
        uploading.value = false
        addLog('danger', 'é”™è¯¯: ' + msg.message)
        ElMessage.error('å¤„ç†å¤±è´¥: ' + msg.message)
        break
    }
  }

  ws.onerror = () => {
    addLog('danger', 'WebSocket è¿æ¥é”™è¯¯')
    uploading.value = false
  }

  ws.onclose = () => {
    addLog('warning', 'WebSocket è¿æ¥å…³é—­')
  }
}

// æ·»åŠ æ—¥å¿—
function addLog(type: string, message: string) {
  logs.value.push({
    id: Date.now(),
    time: new Date().toLocaleTimeString(),
    type,
    message
  })
}

// é‡ç½®è¡¨å•
function resetForm() {
  taskId.value = ''
  progress.value = 0
  logs.value = []
  uploadResult.value = null
  form.youtube_url = ''
}

// æŒ‚è½½æ—¶æ£€æµ‹ Agent
onMounted(() => {
  detectAgent()
})
</script>

<style scoped>
.upload-container {
  padding: 20px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.current-step {
  margin-top: 20px;
  padding: 12px;
  background-color: #f5f7fa;
  border-radius: 4px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.el-code {
  background-color: #f5f5f5;
  padding: 10px;
  border-radius: 4px;
  font-family: monospace;
}
</style>
```

#### Step 3.2ï¼šè·¯ç”±é…ç½®

**ä¿®æ”¹æ–‡ä»¶**ï¼š`/english_tube_admin/src/router/modules/admin.ts`

```typescript
{
  path: "/admin",
  component: Layout,
  children: [
    // ... å…¶ä»–è·¯ç”±
    {
      path: "upload",
      name: "Upload",
      component: () => import("@/views/admin/upload/index.vue"),
      meta: {
        title: "è§†é¢‘ä¸Šä¼ ",
        icon: "Upload",
        roles: ["admin"]
      }
    }
  ]
}
```

---

## ä¸‰ã€ä½¿ç”¨æµç¨‹

### æœ¬åœ°å¼€å‘ç¯å¢ƒ

```bash
# ç»ˆç«¯ 1ï¼šå¯åŠ¨æ•°æ®åº“
cd /Users/winfield/workspace/Apps/projects/english_tube/backend
docker-compose up -d postgres

# ç»ˆç«¯ 2ï¼šå¯åŠ¨ Backend API
python -m uvicorn app.main:app --reload --port 8002

# ç»ˆç«¯ 3ï¼šå¯åŠ¨ Local Uploader Agentï¼ˆæ–°å¢ï¼‰
cd /Users/winfield/workspace/Apps/projects/english_tube/uploader
python -m uploader.agent

# ç»ˆç«¯ 4ï¼šå¯åŠ¨ Vue Admin
cd /Users/winfield/workspace/Apps/projects/english_tube/english_tube_admin
pnpm dev

# æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:8858/admin/upload
```

### çº¿ä¸Šä½¿ç”¨

```bash
# æœ¬åœ°ï¼šå¯åŠ¨ Local Agent
cd /Users/winfield/workspace/Apps/projects/english_tube/uploader
python -m uploader.agent

# æµè§ˆå™¨è®¿é—®ï¼šhttps://yourdomain.com/admin/upload
# Vue Admin è‡ªåŠ¨æ£€æµ‹åˆ°æœ¬åœ° Agentï¼Œæ˜¾ç¤ºä¸Šä¼ åŠŸèƒ½
```

**åŸç†**ï¼š
- Vue Admin çš„ JavaScript åœ¨**æµè§ˆå™¨**ä¸­è¿è¡Œ
- æµè§ˆå™¨è®¿é—® `http://localhost:9000`ï¼ˆç”¨æˆ·æœ¬åœ°ï¼‰
- æ— è®º Vue Admin éƒ¨ç½²åœ¨å“ªé‡Œï¼Œéƒ½èƒ½è®¿é—®ç”¨æˆ·æœ¬åœ°çš„ Agent

---

## å››ã€å…³é”®æ–‡ä»¶æ¸…å•

### éœ€è¦æ–°å»ºçš„æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä½œç”¨ |
|---------|------|
| `/uploader/uploader/agent.py` | Local Agent æœåŠ¡ï¼ˆæ ¸å¿ƒï¼‰ |
| `/uploader/uploader/__main__.py` | Agent å¯åŠ¨å…¥å£ |
| `/uploader/uploader/schemas.py` | æ•°æ®æ¨¡å‹å®šä¹‰ |
| `/backend/app/models/upload_task.py` | ä¸Šä¼ å†å²è®°å½•è¡¨ï¼ˆå¯é€‰ï¼‰ |
| `/backend/app/api/v1/endpoints/upload_history.py` | å†å²æŸ¥è¯¢æ¥å£ï¼ˆå¯é€‰ï¼‰ |
| `/english_tube_admin/src/views/admin/upload/index.vue` | Vue ä¸Šä¼ é¡µé¢ |

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ |
|---------|---------|
| `/english_tube_admin/src/router/modules/admin.ts` | æ·»åŠ ä¸Šä¼ è·¯ç”± |
| `/backend/app/api/v1/api.py` | æ³¨å†Œå†å²æŸ¥è¯¢è·¯ç”±ï¼ˆå¯é€‰ï¼‰ |

### æ ¸å¿ƒä¾èµ–æ–‡ä»¶ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰

| æ–‡ä»¶è·¯å¾„ | é‡è¦æ€§ |
|---------|--------|
| `/uploader/uploader/pipeline.py` | â­â­â­ æ ¸å¿ƒå¤„ç†æµç¨‹ï¼ˆå®Œå…¨å¤ç”¨ï¼‰ |
| `/uploader/uploader/config.py` | â­â­ Uploader é…ç½® |

---

## äº”ã€æŠ€æœ¯è¦ç‚¹

### 5.1 CORS è·¨åŸŸé…ç½®

**é—®é¢˜**ï¼šçº¿ä¸Š Vue Admin è®¿é—®æœ¬åœ° Agent ä¼šé‡åˆ° CORS

**è§£å†³**ï¼š
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:8858",
        "https://yourdomain.com"
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### 5.2 WebSocket å®æ—¶æ¨é€

**åç«¯**ï¼š
```python
async def _broadcast(self, task_id: str, message: dict):
    for ws in self.websockets[task_id]:
        await ws.send_json(message)
```

**å‰ç«¯**ï¼š
```typescript
const ws = new WebSocket(`ws://localhost:9000/ws/${taskId}`)
ws.onmessage = (event) => {
    const msg = JSON.parse(event.data)
    // æ›´æ–° UI
}
```

### 5.3 Agent æ£€æµ‹æœºåˆ¶

```typescript
async function detectAgent() {
  try {
    const response = await fetch('http://localhost:9000/health')
    if (response.ok) {
      agentRunning.value = true
    }
  } catch {
    agentRunning.value = false
  }
}
```

---

## å…­ã€ä¼˜åŠ¿æ€»ç»“

### è§£å†³çš„é—®é¢˜

1. **YouTube è®¿é—®** âœ…
   - å¤„ç†åœ¨æœ¬åœ°ï¼Œå¯ä»¥ä½¿ç”¨ä»£ç†
   - å›½å†…æœåŠ¡å™¨æ— éœ€è®¿é—® YouTube

2. **èµ„æºæ¶ˆè€—** âœ…
   - é‡å‹å¤„ç†åœ¨æœ¬åœ° Mac
   - æœåŠ¡å™¨åªè´Ÿè´£è½»é‡çº§æ•°æ®ç®¡ç†

3. **çµæ´»éƒ¨ç½²** âœ…
   - æœ¬åœ°å’Œçº¿ä¸Š Vue Admin éƒ½èƒ½ç”¨
   - åªè¦æœ¬åœ° Agent è¿è¡Œå³å¯

4. **å®Œå…¨å¤ç”¨** âœ…
   - 100% ä½¿ç”¨ VideoProcessingPipeline
   - ä¸é‡å†™ä»»ä½•å¤„ç†é€»è¾‘

### æ¶æ„ä¼˜åŠ¿

- âœ… ç®€å•ï¼šLocal Agent åªæ˜¯ä¸€ä¸ªè½»é‡çº§ HTTP æœåŠ¡
- âœ… è§£è€¦ï¼šVue Admin ä¸ä¾èµ–æœåŠ¡å™¨å¤„ç†èƒ½åŠ›
- âœ… å®‰å…¨ï¼šæ•°æ®ä»ç„¶å­˜å‚¨åœ¨äº‘ç«¯æ•°æ®åº“
- âœ… å¯æ‰©å±•ï¼šæœªæ¥å¯ä»¥æ”¯æŒå¤šç”¨æˆ·åä½œ

---

## ä¸ƒã€åç»­ä¼˜åŒ–

1. **æ‰¹é‡ä¸Šä¼ **ï¼šæ”¯æŒé˜Ÿåˆ—å¤„ç†å¤šä¸ªè§†é¢‘
2. **å†å²è®°å½•**ï¼šåœ¨ Vue Admin æŸ¥çœ‹æ‰€æœ‰ä¸Šä¼ å†å²
3. **é…ç½®é¢„è®¾**ï¼šä¿å­˜å¸¸ç”¨é…ç½®æ¨¡æ¿
4. **è¿›åº¦æ¢å¤**ï¼šæ–­çº¿é‡è¿åæ¢å¤è¿›åº¦æ˜¾ç¤º
5. **Agent è‡ªå¯åŠ¨**ï¼šmacOS ç™»å½•æ—¶è‡ªåŠ¨å¯åŠ¨ Agent

---

## å…«ã€é¢„è®¡å·¥ä½œé‡

- **Phase 1**ï¼ˆLocal Agentï¼‰ï¼š0.5-1 å¤©
- **Phase 2**ï¼ˆBackend API å¯é€‰ï¼‰ï¼š0.5 å¤©
- **Phase 3**ï¼ˆVue Admin UIï¼‰ï¼š1 å¤©
- **æµ‹è¯•å’Œä¼˜åŒ–**ï¼š0.5 å¤©
- **æ€»è®¡**ï¼š2-3 å¤©

---

## ä¹ã€å¿«é€Ÿå¯åŠ¨æŒ‡å—

```bash
# 1. å®‰è£…ä¾èµ–
cd /Users/winfield/workspace/Apps/projects/english_tube/uploader
pip install fastapi uvicorn websockets

# 2. å¯åŠ¨ Local Agent
python -m uploader.agent

# 3. è®¿é—® Vue Admin
# æµè§ˆå™¨æ‰“å¼€ï¼šhttp://localhost:8858/admin/upload
# æˆ–çº¿ä¸Šï¼šhttps://yourdomain.com/admin/upload

# 4. å¼€å§‹ä¸Šä¼ ï¼
```
